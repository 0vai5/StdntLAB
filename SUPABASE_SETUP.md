# Supabase Setup Guide

This project uses Supabase for authentication. Follow these steps to set up your Supabase project:

## 1. Create a Supabase Project

1. Go to [https://app.supabase.com](https://app.supabase.com)
2. Sign up or log in
3. Click "New Project"
4. Fill in your project details and wait for the project to be created

## 2. Get Your API Keys

1. In your Supabase project dashboard, go to **Settings** → **API**
2. Copy the following values:
   - **Project URL** (under "Project URL")
   - **anon/public key** (under "Project API keys")

## 3. Configure Environment Variables

1. Create a `.env.local` file in the root of your project
2. Add the following variables:

```env
NEXT_PUBLIC_SUPABASE_URL=your_project_url_here
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
```

Replace `your_project_url_here` and `your_anon_key_here` with the values you copied from Supabase.

## 4. Configure Authentication in Supabase

1. Go to **Authentication** → **Providers** in your Supabase dashboard
2. Enable **Email** provider (it should be enabled by default)
3. Configure email templates if needed (optional)

## 5. Set Up Database Schema

Create the `Users` table in your Supabase project:

1. Go to **SQL Editor** in your Supabase dashboard
2. Run the following SQL:

```sql
create table public."Users" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  email text not null,
  name character varying null,
  timezone text null,
  study_times jsonb null,
  updated_at timestamp with time zone null default now(),
  constraint Users_pkey primary key (id),
  constraint Users_email_key unique (email)
) TABLESPACE pg_default;

-- Enable Row Level Security
alter table public."Users" enable row level security;

-- Create policy to allow users to read their own record
create policy "Users can view own record"
  on public."Users" for select
  using (auth.jwt() ->> 'email' = email);

-- Create policy to allow users to update their own record
create policy "Users can update own record"
  on public."Users" for update
  using (auth.jwt() ->> 'email' = email);

-- Create policy to allow insert for authenticated users (during signup)
-- This allows inserts when the email matches the authenticated user's email
create policy "Users can insert own record"
  on public."Users" for insert
  with check (
    auth.uid() is not null and
    auth.jwt() ->> 'email' = email
  );

-- Create a function to automatically create Users record when auth user is created
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public."Users" (email, name)
  values (
    new.email,
    new.raw_user_meta_data->>'name'
  );
  return new;
exception
  when others then
    -- If insert fails, raise an error to prevent auth user creation
    raise exception 'Failed to create user record: %', sqlerrm;
end;
$$ language plpgsql security definer;

-- Create trigger to call the function after auth user is created
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute function public.handle_new_user();
```

## 6. Test the Setup

1. Start your development server:
   ```bash
   pnpm dev
   ```

2. Navigate to `http://localhost:3000`
3. Click "Get Started" to go to the sign-in page
4. Try creating a new account or signing in

## Troubleshooting

- **"Invalid API key"**: Make sure your `.env.local` file has the correct values and is in the root directory
- **"Email not confirmed"**: Check your Supabase project settings → Authentication → Email provider settings
- **CORS errors**: Make sure your Supabase project URL is correct

## Additional Resources

- [Supabase Documentation](https://supabase.com/docs)
- [Supabase Auth Helpers for Next.js](https://supabase.com/docs/guides/auth/auth-helpers/nextjs)
- [Supabase JavaScript Client](https://supabase.com/docs/reference/javascript/introduction)

